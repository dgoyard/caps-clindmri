<?xml version="1.0" encoding="UTF-8"?>
<pipeline version="1.0">

    <docstring>
        Complete preprocessing of diffusion-weighted Nifti images using Connectomist:
          - detection and correction of outlying slices
          - correction of susceptibility-induced distortions using B0 Maps
          - correction of Eddy currents and motion
        Outputs a corrected Nifti with associated .bval and .bvec with corrected gradient directions.
    </docstring>

    <units>
        <unit name="complete_preprocessing">
            <module>clindmri.preproc.connectomist.noniter_complete_preprocessing.xml</module>

            <iterinput name="subject_id"                   />
            <iterinput name="dwi"                          />
            <iterinput name="bval"                         />
            <iterinput name="bvec"                         />
            <iterinput name="manufacturer"                 />
            <iterinput name="b0_magnitude"                 />
            <iterinput name="b0_phase"                     />
            <iterinput name="invertX"                      />
            <iterinput name="invertY"                      />
            <iterinput name="invertZ"                      />
            <iterinput name="delta_TE"                     />
            <iterinput name="partial_fourier_factor"       />
            <iterinput name="parallel_acceleration_factor" />
            <iterinput name="negative_sign"                />
            <iterinput name="echo_spacing"                 />
            <iterinput name="EPI_factor"                   />
            <iterinput name="b0_field"                     />
            <iterinput name="water_fat_shift"              />
            <iterinput name="export_directory"             />

            <iteroutput name="preproc_dwi"                 />
            <iteroutput name="preproc_bval"                />
            <iteroutput name="preproc_bvec"				   />
        </unit>
    </units>

    <links>

        <!-- Pipeline inputs -->
        <link source="subject_ids"                   destination="complete_preprocessing.itersubject_id"                   />
        <link source="dwis"                          destination="complete_preprocessing.iterdwi"                          />
        <link source="bvals"                         destination="complete_preprocessing.iterbval"                         />
        <link source="bvecs"                         destination="complete_preprocessing.iterbvec"                         />
        <link source="manufacturers"                 destination="complete_preprocessing.itermanufacturer"                 />
        <link source="b0_magnitudes"                 destination="complete_preprocessing.iterb0_magnitude"                 />
        <link source="b0_phases"                     destination="complete_preprocessing.iterb0_phase"                     />
        <link source="invertXs"                      destination="complete_preprocessing.iterinvertX"                      />
        <link source="invertYs"                      destination="complete_preprocessing.iterinvertY"                      />
        <link source="invertZs"                      destination="complete_preprocessing.iterinvertZ"                      />
        <link source="delta_TEs"                     destination="complete_preprocessing.iterdelta_TE"                     />
        <link source="partial_fourier_factors"       destination="complete_preprocessing.iterpartial_fourier_factor"       />
        <link source="parallel_acceleration_factors" destination="complete_preprocessing.iterparallel_acceleration_factor" />
        <link source="negative_signs"                destination="complete_preprocessing.iternegative_sign"                />
        <link source="echo_spacings"                 destination="complete_preprocessing.iterecho_spacing"                 />
        <link source="EPI_factors"                   destination="complete_preprocessing.iterEPI_factor"                   />
        <link source="b0_fields"                     destination="complete_preprocessing.iterb0_field"                     />
        <link source="water_fat_shifts"              destination="complete_preprocessing.iterwater_fat_shift"              />
        <link source="outdirs"                      destination="complete_preprocessing.iterexport_directory"             />
        <link source="delete_steps"                  destination="complete_preprocessing.delete_steps"                     />

        <!-- Pipeline outputs -->
        <link source="complete_preprocessing.iterpreproc_dwi"  destination="preproc_dwis"  />
        <link source="complete_preprocessing.iterpreproc_bval" destination="preproc_bvals" />
        <link source="complete_preprocessing.iterpreproc_bvec" destination="preproc_bvecs" />

    </links>

    <positions>
        <position unit="inputs"                 x="50"  y="50"  />
        <position unit="complete_preprocessing" x="389" y="49"  />
        <position unit="outputs"                x="722" y="549" />
    </positions>

    <zoom level="1"/>
</pipeline>
